<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>üêü Fish</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@700;800;900&display=swap');

:root {
  --felt: #cc2200;
  --felt-dark: #aa1a00;
  --gold: #f1c40f;
  --green: #27ae60;
  --blue: #2980b9;
  --panel: rgba(0,0,0,.55);
  --radius: 14px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'Nunito', sans-serif;
  background: var(--felt);
  min-height: 100dvh;
  display: flex; align-items: center; justify-content: center;
  overflow: hidden;
}

/* Rich red felt texture like the image */
body::before {
  content: ''; position: fixed; inset: 0;
  background:
    radial-gradient(ellipse 80% 60% at 50% 40%, rgba(180,20,0,.35) 0%, transparent 70%),
    repeating-linear-gradient(0deg, rgba(0,0,0,.06) 0, rgba(0,0,0,.06) 1px, transparent 0, transparent 3px),
    repeating-linear-gradient(90deg, rgba(0,0,0,.04) 0, rgba(0,0,0,.04) 1px, transparent 0, transparent 3px);
  pointer-events: none; z-index: 0;
}
body::after {
  content: ''; position: fixed; inset: 0;
  background: radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,.25) 100%);
  pointer-events: none; z-index: 0;
}

#app {
  position: relative; z-index: 1;
  width: 100%; max-width: 480px;
  height: 100dvh;
  display: flex; flex-direction: column;
}

/* ‚ïê‚ïê SCREENS ‚ïê‚ïê */
.screen {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 20px 16px; gap: 14px;
  transition: opacity .25s, transform .25s;
  overflow-y: auto;
}
.screen.hidden { opacity: 0; pointer-events: none; transform: scale(.97); }

/* ‚ïê‚ïê LOBBY STYLES ‚ïê‚ïê */
.fish-title {
  font-family: 'Fredoka One', cursive;
  font-size: 64px; color: #fff;
  text-shadow: 0 4px 24px rgba(0,0,0,.5), 0 2px 0 rgba(0,0,0,.4);
  letter-spacing: 3px; line-height: 1;
}
.fish-title span { color: var(--gold); }
.subtitle { color: rgba(255,255,255,.75); font-size: 13px; font-weight: 800; letter-spacing: .5px; }

.box {
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(14px);
  border-radius: var(--radius);
  padding: 20px 18px; width: 100%;
  display: flex; flex-direction: column; gap: 12px;
  border: 1px solid rgba(255,255,255,.12);
}
.box h2 { color: #fff; font-size: 14px; font-weight: 900; letter-spacing: .5px; }

.lbl { color: rgba(255,255,255,.55); font-size: 10px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px; }
input[type=text] {
  width: 100%; padding: 11px 14px; border-radius: 10px;
  border: 2px solid rgba(255,255,255,.15);
  background: rgba(255,255,255,.1); color: #fff;
  font-family: 'Nunito', sans-serif; font-size: 16px; font-weight: 700;
  outline: none; transition: border-color .2s;
}
input[type=text]:focus { border-color: var(--gold); }
input[type=text]::placeholder { color: rgba(255,255,255,.3); }

.team-row { display: flex; gap: 8px; }
.tbtn {
  flex: 1; padding: 9px; border-radius: 10px;
  border: 2px solid transparent;
  font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 13px;
  cursor: pointer; transition: all .2s;
  background: rgba(255,255,255,.08); color: rgba(255,255,255,.55);
}
.tbtn.t0 { border-color: var(--green); }
.tbtn.t1 { border-color: var(--blue); }
.tbtn.sel.t0 { background: var(--green); color: #fff; }
.tbtn.sel.t1 { background: var(--blue); color: #fff; }

.slots { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
.slot {
  background: rgba(255,255,255,.07); border-radius: 8px;
  padding: 7px 9px; display: flex; align-items: center; gap: 7px;
  border: 1.5px solid rgba(255,255,255,.1); min-height: 38px;
}
.slot.f0 { border-color: rgba(39,174,96,.5); background: rgba(39,174,96,.08); }
.slot.f1 { border-color: rgba(41,128,185,.5); background: rgba(41,128,185,.08); }
.slot .sname { color: #fff; font-size: 11px; font-weight: 800; }
.slot .sempty { color: rgba(255,255,255,.3); font-size: 10px; }
.sdot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
.sdot.t0 { background: var(--green); } .sdot.t1 { background: var(--blue); }
.syou { color: var(--gold); font-size: 9px; font-weight: 900; margin-left: auto; }

.bigbtn {
  width: 100%; padding: 14px; border-radius: 12px; border: none;
  font-family: 'Fredoka One', cursive; font-size: 20px; letter-spacing: .5px;
  cursor: pointer; transition: transform .12s, box-shadow .12s;
  box-shadow: 0 4px 14px rgba(0,0,0,.35);
}
.bigbtn:hover { transform: translateY(-2px); box-shadow: 0 6px 18px rgba(0,0,0,.45); }
.bigbtn:active { transform: scale(.97); }
.bigbtn:disabled { opacity: .4; cursor: default; transform: none; }
.bg  { background: var(--gold); color: #2c3e50; }
.bgr { background: var(--green); color: #fff; }
.bgh { background: rgba(255,255,255,.12); color: rgba(255,255,255,.8); font-size: 16px; }

.codebox {
  background: rgba(0,0,0,.35); border-radius: 10px;
  padding: 10px 14px; display: flex; align-items: center;
  justify-content: space-between; gap: 10px;
}
.gamecode { font-family: 'Fredoka One', cursive; font-size: 30px; color: var(--gold); letter-spacing: 5px; }
.sharebtns { display: flex; gap: 6px; }
.copybtn {
  padding: 6px 11px; border-radius: 8px; border: none;
  background: rgba(255,255,255,.15); color: #fff;
  font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 11px;
  cursor: pointer; transition: background .15s; white-space: nowrap;
}
.copybtn:hover { background: rgba(255,255,255,.28); }
.copybtn.gold { background: rgba(241,196,15,.25); color: var(--gold); border: 1px solid rgba(241,196,15,.4); }

.imsg { color: rgba(255,255,255,.55); font-size: 12px; font-weight: 700; text-align: center; line-height: 1.5; }
.imsg.ok   { color: #2ecc71; }
.imsg.err  { color: #e74c3c; }
.imsg.warn { color: #f39c12; }

/* ‚ïê‚ïê GAME SCREEN ‚ïê‚ïê */
#screen-game {
  justify-content: flex-start;
  align-items: stretch;   /* children fill full width */
  padding: 0; gap: 0;
  overflow: hidden;
  position: absolute;
  inset: 0;
  display: flex;
  flex-direction: column;
}

/* Topbar */
#topbar {
  display: flex; justify-content: space-between; align-items: center;
  padding: 8px 12px; background: rgba(0,0,0,.35); flex-shrink: 0;
  border-bottom: 1px solid rgba(0,0,0,.3);
  position: relative; z-index: 10;
}
.schip {
  background: rgba(0,0,0,.4); border-radius: 20px;
  padding: 5px 14px; font-size: 14px; font-weight: 900; color: #fff;
  box-shadow: inset 0 1px 0 rgba(255,255,255,.1);
}
.schip.t0 { color: #2ecc71; } .schip.t1 { color: #3498db; }
#turnbadge {
  background: rgba(0,0,0,.4); border-radius: 20px;
  padding: 5px 12px; font-size: 11px; font-weight: 900; color: var(--gold);
  text-align: center; max-width: 170px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}

/* ‚ïê‚ïê TABLE ‚ïê‚ïê */
#table {
  flex: 1;
  position: relative;
  min-height: 220px; /* guaranteed space for hexagon */
  overflow: visible;
}

/* Player tokens ‚Äî positioned fully inline via JS */
.ptok {
  display: flex; flex-direction: column;
  align-items: center; gap: 4px;
}
.pav {
  width: 52px; height: 52px; border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; position: relative;
  box-shadow: 0 4px 14px rgba(0,0,0,.5), 0 0 0 3px rgba(255,255,255,.2);
  transition: box-shadow .3s, transform .2s;
}
/* Team-colored avatar backgrounds like in the image */
.pav.t0 { background: radial-gradient(circle at 35% 35%, #5dade2, #1a6688); box-shadow: 0 4px 14px rgba(0,0,0,.5), 0 0 0 3px #2ecc71; }
.pav.t1 { background: radial-gradient(circle at 35% 35%, #ec7063, #922b21); box-shadow: 0 4px 14px rgba(0,0,0,.5), 0 0 0 3px #3498db; }
.pav.active {
  box-shadow: 0 0 0 3px var(--gold), 0 0 20px rgba(241,196,15,.7), 0 4px 14px rgba(0,0,0,.5);
  animation: glow 1.8s ease-in-out infinite;
}
@keyframes glow {
  0%,100% { box-shadow: 0 0 0 3px var(--gold), 0 0 18px rgba(241,196,15,.6), 0 4px 14px rgba(0,0,0,.5); }
  50%      { box-shadow: 0 0 0 4px var(--gold), 0 0 30px rgba(241,196,15,.9), 0 4px 14px rgba(0,0,0,.5); }
}
.ptag {
  background: rgba(0,0,0,.8); color: #fff;
  font-size: 11px; font-weight: 900; padding: 3px 9px;
  border-radius: 10px; white-space: nowrap;
  max-width: 90px; overflow: hidden; text-overflow: ellipsis;
  letter-spacing: .2px; text-align: center;
  box-shadow: 0 2px 6px rgba(0,0,0,.4);
  margin-top: 2px;
}
.ptag-team { font-size: 9px; text-align: center; }
/* Tappable opponent glow - pulses to show they're askable */
.pav.tappable {
  cursor: pointer;
  animation: tappable-pulse 2.5s ease-in-out infinite;
}
.pav.tappable:hover {
  transform: scale(1.12);
  box-shadow: 0 0 0 4px #fff, 0 0 24px rgba(255,255,255,.7), 0 4px 14px rgba(0,0,0,.5) !important;
}
@keyframes tappable-pulse {
  0%,100% { filter: brightness(1); }
  50% { filter: brightness(1.25); }
}
.cbadge {
  position: absolute; bottom: -2px; right: -2px;
  background: #111; color: #fff; font-size: 9px; font-weight: 900;
  padding: 1px 5px; border-radius: 8px; border: 2px solid rgba(255,255,255,.4);
  font-family: 'Fredoka One', cursive;
}

/* Center action display ‚Äî in the middle of the hexagon */
#centerinfo {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  z-index: 6; pointer-events: none;
  width: 55%;
}
.actionbox {
  background: rgba(0,0,0,.75); backdrop-filter: blur(10px);
  border-radius: 12px; padding: 7px 14px; color: #fff;
  font-size: 11px; font-weight: 800; text-align: center;
  max-width: 180px; line-height: 1.4;
  border: 1px solid rgba(255,255,255,.12);
  box-shadow: 0 4px 20px rgba(0,0,0,.4);
}
.yes { color: #2ecc71; } .no { color: #e74c3c; }

/* ‚ïê‚ïê CLAIMED AREA ‚Äî center of hexagon ‚ïê‚ïê */
#claimedarea {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -30%);
  display: flex; gap: 10px; z-index: 4;
  pointer-events: none; align-items: flex-start;
  max-width: 50%;
  flex-wrap: wrap; justify-content: center;
}
.claimed-col {
  display: flex; flex-direction: column; gap: 4px; align-items: center;
  min-width: 70px;
}
.claimed-col-label {
  font-size: 9px; font-weight: 900; text-transform: uppercase;
  letter-spacing: 1px; color: rgba(255,255,255,.6); margin-bottom: 2px;
}
/* Each claimed half-suit shown as a mini card stack */
.ccstack {
  position: relative; width: 46px; height: 62px;
  animation: claimDrop .4s cubic-bezier(.34,1.56,.64,1) forwards;
}
@keyframes claimDrop {
  0% { transform: scale(0) rotate(-10deg); opacity: 0; }
  100% { transform: scale(1) rotate(0); opacity: 1; }
}
.ccstack-card {
  position: absolute; width: 46px; height: 62px;
  border-radius: 8px; display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  font-weight: 900; font-family: 'Fredoka One', cursive;
  border: 2px solid rgba(255,255,255,.4);
  box-shadow: 0 3px 8px rgba(0,0,0,.5);
  font-size: 13px;
}
.ccstack-card:nth-child(1) { transform: rotate(-4deg) translate(-2px, 2px); z-index: 1; }
.ccstack-card:nth-child(2) { transform: rotate(2deg) translate(1px, 0); z-index: 2; }
.ccstack-card:nth-child(3) { transform: rotate(0deg); z-index: 3; }
.ccstack-card.t0 { background: linear-gradient(160deg, #27ae60, #1a7a44); color: #fff; }
.ccstack-card.t1 { background: linear-gradient(160deg, #2980b9, #1a5276); color: #fff; }
.ccstack-name {
  position: absolute; bottom: -16px; left: 50%;
  transform: translateX(-50%);
  font-size: 8px; font-weight: 900; color: rgba(255,255,255,.75);
  white-space: nowrap; text-align: center;
  background: rgba(0,0,0,.5); padding: 1px 5px; border-radius: 6px;
}

/* ‚ïê‚ïê HAND ‚Äî colorful cards like the image ‚ïê‚ïê */
#handsec {
  flex-shrink: 0;
  background: rgba(0,0,0,.5);
  border-top: 2px solid rgba(0,0,0,.4);
  padding: 6px 0 2px;
  position: relative; z-index: 8;
}
#handscroll {
  display: flex; gap: 6px; overflow-x: auto;
  padding: 0 10px 8px; scrollbar-width: none;
}
#handscroll::-webkit-scrollbar { display: none; }

/* Real playing card design */
.card {
  width: 56px; height: 78px; border-radius: 8px;
  background: #fff;
  cursor: pointer; flex-shrink: 0;
  border: 1.5px solid #ddd;
  box-shadow: 0 4px 12px rgba(0,0,0,.5);
  transition: transform .15s, box-shadow .15s;
  user-select: none; position: relative;
  padding: 4px 5px;
  display: flex; flex-direction: column;
}
.card:hover { transform: translateY(-8px); box-shadow: 0 12px 20px rgba(0,0,0,.6); }
.card.sel {
  transform: translateY(-16px);
  box-shadow: 0 0 0 3px var(--gold), 0 14px 24px rgba(241,196,15,.5);
}
/* Top-left corner: rank + suit stacked */
.card .corner-tl {
  display: flex; flex-direction: column; align-items: flex-start; line-height: 1; gap: 1px;
}
/* No bottom-right corner ‚Äî hidden via CSS */
.card .corner-br { display: none; }
/* Large center suit */
.card .c-center {
  position: absolute; top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 26px; line-height: 1;
}
.card .c-rank { font-size: 15px; font-weight: 900; font-family: 'Fredoka One', cursive; line-height: 1; }
.card .c-suit { font-size: 12px; line-height: 1; }

/* ‚îÄ‚îÄ Suit colors ‚îÄ‚îÄ */
.c-hearts  .c-rank, .c-hearts  .c-suit, .c-hearts  .c-center { color: #e74c3c; }
.c-diamonds .c-rank,.c-diamonds .c-suit,.c-diamonds .c-center { color: #2980b9; }
.c-spades  .c-rank, .c-spades  .c-suit, .c-spades  .c-center { color: #1a1a2e; }
.c-clubs   .c-rank, .c-clubs   .c-suit, .c-clubs   .c-center { color: #27ae60; }

/* Joker BW */
.c-joker-bw { background: #fff; border: 2px solid #222 !important; }
/* Joker Colored */
.c-joker-col { background: #fff; border: 2px solid #c0392b !important; }

/* 8s ‚Äî gold background, suit colors same as above */
.c-eights { background: linear-gradient(135deg,#f7dc6f,#e8a020); }
.c-eights .c-rank, .c-eights .c-suit, .c-eights .c-center { color: inherit; }
.c-eights.c-hearts  .c-rank,.c-eights.c-hearts  .c-suit,.c-eights.c-hearts  .c-center { color: #e74c3c; }
.c-eights.c-diamonds .c-rank,.c-eights.c-diamonds .c-suit,.c-eights.c-diamonds .c-center { color: #2980b9; }
.c-eights.c-spades  .c-rank,.c-eights.c-spades  .c-suit,.c-eights.c-spades  .c-center { color: #1a1a2e; }
.c-eights.c-clubs   .c-rank,.c-eights.c-clubs   .c-suit,.c-eights.c-clubs   .c-center { color: #27ae60; }

/* ‚ïê‚ïê CALL MODAL ‚ïê‚ïê */
#call-modal {
  position: fixed; inset: 0; z-index: 500;
  background: rgba(0,0,0,.75); backdrop-filter: blur(6px);
  display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity .25s;
}
#call-modal.open { opacity: 1; pointer-events: all; }
#call-box {
  background: #1a0800; border: 1px solid rgba(255,255,255,.12);
  border-radius: 20px 20px 0 0; padding: 18px 16px 24px;
  width: 100%; max-width: 480px;
  display: flex; flex-direction: column; gap: 14px;
  max-height: 90vh; overflow-y: auto;
}
#call-box h3 { color:#fff; font-size:16px; font-weight:900; margin:0; text-align:center; }
.call-hs-btn {
  background: rgba(255,255,255,.08); border: 2px solid rgba(255,255,255,.15);
  border-radius: 12px; padding: 10px 14px; color:#fff; cursor:pointer;
  font-family:'Nunito',sans-serif; font-weight:900; font-size:13px;
  display: flex; align-items:center; gap:8px; transition: all .15s;
}
.call-hs-btn:hover { background: rgba(255,255,255,.15); border-color: var(--gold); }
.call-hs-btn.active { border-color: var(--gold); background: rgba(241,196,15,.15); }
.call-teammate-row {
  display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
}
.call-teammate-btn {
  background: rgba(255,255,255,.1); border: 2px solid rgba(255,255,255,.2);
  border-radius: 14px; padding: 8px 14px; color:#fff; cursor:pointer;
  font-family:'Nunito',sans-serif; font-weight:900; font-size:13px;
  display:flex; flex-direction:column; align-items:center; gap:4px;
  transition: all .15s; min-width: 80px;
}
.call-teammate-btn.selected { border-color: var(--gold); background: rgba(241,196,15,.2); }
.call-card-grid {
  display: flex; flex-wrap: wrap; gap: 6px; justify-content: center;
}
.call-card-slot {
  width: 46px; height: 62px; border-radius: 8px; background:#fff;
  border: 2px solid #ddd; display:flex; flex-direction:column;
  justify-content:space-between; padding:3px; cursor:pointer;
  position:relative; transition: border-color .15s;
  font-size:11px; font-weight:900;
}
.call-card-slot.assigned { border-color: var(--gold); }
.call-card-slot .cs-rank { font-size:12px; font-weight:900; line-height:1; font-family:'Fredoka One',cursive; }
.call-card-slot .cs-suit { font-size:10px; line-height:1; }
.call-card-slot .cs-center { position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:16px; }
.call-confirm-btn {
  background: var(--gold); border:none; border-radius:12px;
  padding:12px; color:#1a0800; font-weight:900; font-size:15px;
  cursor:pointer; width:100%; transition: transform .1s;
}
.call-confirm-btn:hover { transform:scale(1.02); }
.call-cancel-btn {
  background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.15);
  border-radius:12px; padding:10px; color:#fff; font-weight:700; font-size:13px;
  cursor:pointer; width:100%;
}

/* ‚ïê‚ïê ACTION PANEL ‚ïê‚ïê */
#actionpanel {
  flex-shrink: 0; background: rgba(0,0,0,.65);
  backdrop-filter: blur(14px); border-top: 1px solid rgba(255,255,255,.06);
  padding: 8px 12px 10px; display: flex; flex-direction: column; gap: 8px;
  max-height: 26vh; overflow-y: auto; scrollbar-width: none;
  position: relative; z-index: 8;
}
#actionpanel::-webkit-scrollbar { display: none; }

.pmsg { color: rgba(255,255,255,.5); font-size: 12px; font-weight: 700; text-align: center; padding: 4px; }

/* Step 1: cards you can ask for ‚Äî displayed as a horizontal row of cards */
.askable-label {
  font-size: 10px; font-weight: 900; color: rgba(255,255,255,.5);
  text-transform: uppercase; letter-spacing: 1px; text-align: center;
}
#askable-cards {
  display: flex; gap: 7px; overflow-x: auto; padding: 2px 2px 4px;
  scrollbar-width: none; justify-content: center; flex-wrap: wrap;
}
#askable-cards::-webkit-scrollbar { display: none; }

/* Askable card ‚Äî real card look, tappable */
.acard {
  width: 54px; height: 74px; border-radius: 8px;
  background: #fff; cursor: pointer; flex-shrink: 0;
  border: 1.5px solid #ccc;
  box-shadow: 0 4px 12px rgba(0,0,0,.5);
  transition: transform .15s, box-shadow .15s, border-color .15s;
  user-select: none; display: flex; flex-direction: column;
  justify-content: space-between; padding: 3px 4px; position: relative;
}
.acard:hover { transform: translateY(-6px); box-shadow: 0 10px 20px rgba(0,0,0,.6); }
.acard.chosen {
  transform: translateY(-10px);
  border-color: var(--gold);
  box-shadow: 0 0 0 3px var(--gold), 0 12px 24px rgba(241,196,15,.5);
  background: #fff !important;
}
.acard .ac-tl { display: flex; flex-direction: column; align-items: flex-start; gap: 1px; line-height: 1; }
.acard .ac-br { display: none; }
.acard .ac-r { font-size: 13px; font-weight: 900; font-family: 'Fredoka One', cursive; line-height: 1; }
.acard .ac-s { font-size: 10px; line-height: 1; }
.acard .ac-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 22px; }
.acard.c-hearts   .ac-r,.acard.c-hearts   .ac-s,.acard.c-hearts   .ac-center { color: #e74c3c; }
.acard.c-diamonds .ac-r,.acard.c-diamonds .ac-s,.acard.c-diamonds .ac-center { color: #2980b9; }
.acard.c-spades   .ac-r,.acard.c-spades   .ac-s,.acard.c-spades   .ac-center { color: #1a1a2e; }
.acard.c-clubs    .ac-r,.acard.c-clubs    .ac-s,.acard.c-clubs    .ac-center { color: #27ae60; }
.acard.c-eights.c-hearts   .ac-r,.acard.c-eights.c-hearts   .ac-s,.acard.c-eights.c-hearts   .ac-center { color: #e74c3c; }
.acard.c-eights.c-diamonds .ac-r,.acard.c-eights.c-diamonds .ac-s,.acard.c-eights.c-diamonds .ac-center { color: #2980b9; }
.acard.c-eights.c-spades   .ac-r,.acard.c-eights.c-spades   .ac-s,.acard.c-eights.c-spades   .ac-center { color: #1a1a2e; }
.acard.c-eights.c-clubs    .ac-r,.acard.c-eights.c-clubs    .ac-s,.acard.c-eights.c-clubs    .ac-center { color: #27ae60; }

/* Step 2: opponent buttons ‚Äî shown after tapping an askable card */
#opp-section { display: flex; flex-direction: column; gap: 6px; }
.opp-label {
  font-size: 10px; font-weight: 900; color: rgba(255,255,255,.5);
  text-transform: uppercase; letter-spacing: 1px; text-align: center;
}
#opp-btns { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
.minicard {
  width: 38px; height: 52px; border-radius: 6px;
  background: #fff; display: flex; flex-direction: column;
  justify-content: space-between; flex-shrink: 0;
  box-shadow: 0 2px 8px rgba(0,0,0,.5);
  border: 1px solid #ccc; padding: 2px 3px; position: relative;
}
.minicard .mc-tl { display: flex; flex-direction: column; line-height: 1; }
.minicard .mc-br { display: flex; flex-direction: column; line-height: 1; align-items: flex-end; transform: rotate(180deg); }
.minicard .mc-r { font-size: 11px; font-weight: 900; font-family: 'Fredoka One', cursive; line-height: 1; }
.minicard .mc-s { font-size: 9px; line-height: 1; }
.minicard .mc-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); font-size: 14px; }
.minicard.c-hearts .mc-r,.minicard.c-hearts .mc-s,.minicard.c-diamonds .mc-r,.minicard.c-diamonds .mc-s { color: #c0392b; }
.minicard.c-hearts .mc-center { color: #e74c3c; }
.minicard.c-diamonds .mc-center { color: #2980b9; }
.minicard.c-spades .mc-r,.minicard.c-spades .mc-s,.minicard.c-clubs .mc-r,.minicard.c-clubs .mc-s { color: #1a1a2e; }
.minicard.c-spades .mc-center { color: #1a1a2e; }
.minicard.c-clubs .mc-center { color: #27ae60; }

.oppbtn {
  padding: 8px 14px; border-radius: 20px;
  font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 13px;
  border: 2px solid rgba(255,255,255,.2); cursor: pointer; transition: all .15s; white-space: nowrap;
  background: rgba(255,255,255,.12); color: #fff;
  box-shadow: 0 3px 8px rgba(0,0,0,.3);
  display: flex; align-items: center; gap: 6px;
}
.oppbtn:hover { background: rgba(255,255,255,.25); transform: scale(1.05); border-color: rgba(255,255,255,.4); }
.oppbtn:active { transform: scale(.95); }
.oppbtn .oname { font-size: 13px; }
.oppbtn .ocount { font-size: 10px; opacity: .6; }

.btnrow { display: flex; gap: 6px; }
.btn {
  padding: 7px 14px; border-radius: 20px;
  font-family: 'Nunito', sans-serif; font-weight: 900; font-size: 12px;
  border: none; cursor: pointer; transition: transform .1s;
  box-shadow: 0 2px 8px rgba(0,0,0,.3);
}
.btn:active { transform: scale(.93); }
.btn:disabled { opacity: .4; cursor: default; }
.btn-gold { background: var(--gold); color: #2c3e50; }
.btn-dark { background: rgba(255,255,255,.14); color: #fff; }
#logline { font-size: 10px; font-weight: 700; color: rgba(255,255,255,.4); text-align: center; min-height: 14px; }

/* ‚ïê‚ïê CHAT PANEL ‚ïê‚ïê */
#chat-btn {
  position: fixed; bottom: 20px; right: 16px;
  width: 48px; height: 48px; border-radius: 50%;
  background: var(--gold); border: none; cursor: pointer;
  font-size: 22px; z-index: 150;
  box-shadow: 0 4px 16px rgba(0,0,0,.5);
  display: none; /* shown only in game */
  align-items: center; justify-content: center;
  transition: transform .15s;
}
#chat-btn:hover { transform: scale(1.1); }
#chat-btn .cbadge2 {
  position: absolute; top: -4px; right: -4px;
  background: #e74c3c; color: #fff; font-size: 9px; font-weight: 900;
  width: 16px; height: 16px; border-radius: 50%;
  display: none; align-items: center; justify-content: center;
}

#chat-panel {
  position: fixed; bottom: 0; left: 50%; 
  transform: translateX(-50%) translateY(100%);
  width: 100%; max-width: 480px;
  height: 65vh; max-height: 520px;
  background: rgba(10,3,3,.97);
  backdrop-filter: blur(16px);
  border-radius: 20px 20px 0 0;
  border: 1px solid rgba(255,255,255,.12);
  border-bottom: none;
  display: flex; flex-direction: column;
  z-index: 300;
  transition: transform .35s cubic-bezier(.34,1.2,.64,1);
  box-shadow: 0 -8px 40px rgba(0,0,0,.7);
}
#chat-panel.open {
  transform: translateX(-50%) translateY(0);
}
/* .open handled above */
#chat-header {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px 10px;
  border-bottom: 1px solid rgba(255,255,255,.08);
  flex-shrink: 0;
}
#chat-header span { color: #fff; font-size: 14px; font-weight: 900; }
#chat-close {
  background: rgba(255,255,255,.12); border: none; color: #fff;
  width: 28px; height: 28px; border-radius: 50%; cursor: pointer;
  font-size: 14px; display: flex; align-items: center; justify-content: center;
}
#chat-messages {
  flex: 1; overflow-y: auto; padding: 10px 14px;
  display: flex; flex-direction: column; gap: 8px;
  scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.15) transparent;
}
.cmsg {
  display: flex; flex-direction: column; gap: 2px; max-width: 85%;
}
.cmsg.mine { align-self: flex-end; align-items: flex-end; }
.cmsg.theirs { align-self: flex-start; align-items: flex-start; }
.cmsg-name { font-size: 9px; font-weight: 900; opacity: .6; color: #fff; padding: 0 4px; }
.cmsg-bubble {
  padding: 7px 12px; border-radius: 16px;
  font-size: 13px; font-weight: 700; line-height: 1.4;
  max-width: 100%; word-break: break-word;
}
.cmsg.mine .cmsg-bubble { background: var(--gold); color: #1a0a00; border-radius: 16px 16px 4px 16px; }
.cmsg.theirs.t0 .cmsg-bubble { background: rgba(39,174,96,.3); color: #fff; border: 1px solid rgba(39,174,96,.4); border-radius: 16px 16px 16px 4px; }
.cmsg.theirs.t1 .cmsg-bubble { background: rgba(41,128,185,.3); color: #fff; border: 1px solid rgba(41,128,185,.4); border-radius: 16px 16px 16px 4px; }
.cmsg-time { font-size: 8px; opacity: .4; color: #fff; padding: 0 4px; }
.csystem {
  text-align: center; font-size: 10px; font-weight: 700;
  color: rgba(255,255,255,.4); padding: 2px 0;
}
#chat-input-row {
  display: flex; gap: 8px; padding: 10px 12px 14px;
  border-top: 1px solid rgba(255,255,255,.08); flex-shrink: 0;
}
#chat-input {
  flex: 1; background: rgba(255,255,255,.1);
  border: 1px solid rgba(255,255,255,.15); border-radius: 20px;
  color: #fff; padding: 9px 14px; font-size: 13px;
  font-family: 'Nunito', sans-serif; font-weight: 700; outline: none;
}
#chat-input:focus { border-color: var(--gold); }
#chat-input::placeholder { color: rgba(255,255,255,.3); }
#chat-send {
  background: var(--gold); border: none; border-radius: 50%;
  width: 38px; height: 38px; cursor: pointer; font-size: 16px;
  flex-shrink: 0; display: flex; align-items: center; justify-content: center;
  transition: transform .1s;
}
#chat-send:hover { transform: scale(1.1); }

/* ‚ïê‚ïê ANNOUNCEMENT BANNER ‚ïê‚ïê */
#announce {
  position: fixed; top: 0; left: 50%;
  transform: translateX(-50%) translateY(-110%);
  z-index: 300; max-width: 480px; width: 100%;
  background: rgba(0,0,0,.88); backdrop-filter: blur(12px);
  border-bottom: 3px solid var(--gold);
  padding: 13px 18px; text-align: center;
  color: #fff; font-size: 15px; font-weight: 900;
  transition: transform .4s cubic-bezier(.34,1.56,.64,1);
  letter-spacing: .2px;
}
#announce.show { transform: translateX(-50%) translateY(0); }
.ann-yes    { color: #2ecc71; }
.ann-no     { color: #e74c3c; }
.ann-trophy { color: var(--gold); }

/* Modal */
#modal {
  position: fixed; inset: 0; background: rgba(0,0,0,.8);
  display: flex; align-items: center; justify-content: center;
  z-index: 200; backdrop-filter: blur(6px);
}
#modal.hidden { display: none; }
.modalbox {
  background: linear-gradient(160deg, #2c0a0a, #1a0505);
  border: 1px solid rgba(255,255,255,.15);
  border-radius: 20px; padding: 28px 22px; max-width: 320px; width: 90%;
  color: #fff; text-align: center;
  box-shadow: 0 20px 60px rgba(0,0,0,.6);
}
.modalbox h2 { font-family: 'Fredoka One', cursive; font-size: 28px; margin-bottom: 8px; color: var(--gold); }
.modalbox p  { font-size: 13px; opacity: .85; margin-bottom: 20px; line-height: 1.7; }

/* Toast */
#toast {
  position: fixed; bottom: 90px; left: 50%;
  transform: translateX(-50%) translateY(20px);
  background: rgba(0,0,0,.88); color: #fff; padding: 9px 18px;
  border-radius: 20px; font-size: 13px; font-weight: 800;
  z-index: 250; opacity: 0; transition: opacity .3s, transform .3s;
  border: 1px solid rgba(255,255,255,.12); white-space: nowrap;
}
#toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

@keyframes bouncein {
  0% { transform: scale(0); opacity: 0; }
  70%{ transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; }
}
.bouncein { animation: bouncein .35s ease forwards; }
</style>
</head>
<body>
<div id="app">

  <!-- LOBBY -->
  <div class="screen" id="screen-lobby">
    <div class="fish-title">üêü <span>FISH</span></div>
    <p class="subtitle">Multiplayer ¬∑ 6 Players ¬∑ 2 Teams</p>
    <div class="box">
      <h2>Create a Game</h2>
      <div><div class="lbl">Your Name</div><input type="text" id="create-name" placeholder="Enter your name..." maxlength="18"></div>
      <div><div class="lbl">Pick Team</div>
        <div class="team-row">
          <button class="tbtn t0" id="tbtn0" onclick="pickTeam(0)">üü¢ Green</button>
          <button class="tbtn t1" id="tbtn1" onclick="pickTeam(1)">üîµ Blue</button>
        </div>
      </div>
      <button class="bigbtn bg" onclick="createGame()">Create Game Room</button>
      <button class="bigbtn bgh" onclick="startDemo()">üéÆ Solo Demo</button>
    </div>
    <div class="box" style="gap:10px">
      <h2>Join a Game</h2>
      <div style="display:flex;gap:8px">
        <input type="text" id="join-code-input" placeholder="XXXX" maxlength="6"
          style="text-transform:uppercase;letter-spacing:4px;font-family:'Fredoka One',cursive;font-size:24px"
          oninput="this.value=this.value.replace(/[^A-Za-z0-9]/g,'').toUpperCase()"
          onkeydown="if(event.key==='Enter')goJoin()">
        <button class="bigbtn bg" style="width:auto;padding:14px 18px;font-size:18px" onclick="goJoin()">‚Üí</button>
      </div>
    </div>
  </div>

  <!-- JOIN ROOM -->
  <div class="screen hidden" id="screen-join">
    <div class="fish-title" style="font-size:42px">üêü Join Game</div>
    <div class="box" style="gap:13px">
      <div class="codebox"><div><div class="lbl">Game Code</div><div class="gamecode" id="join-code-display">----</div></div></div>
      <div><div class="lbl">Your Name</div><input type="text" id="join-name" placeholder="Enter your name..." maxlength="18"></div>
      <div><div class="lbl">Pick Team</div>
        <div class="team-row">
          <button class="tbtn t0" id="join-tbtn0" onclick="pickJoinTeam(0)">üü¢ Green</button>
          <button class="tbtn t1" id="join-tbtn1" onclick="pickJoinTeam(1)">üîµ Blue</button>
        </div>
      </div>
      <div class="slots" id="join-slots"></div>
      <div id="join-msg" class="imsg"></div>
      <button class="bigbtn bgr" id="btn-join-confirm" onclick="joinGame()">Join Game</button>
      <button class="bigbtn bgh" onclick="showScreen('screen-lobby')" style="font-size:14px">‚Üê Back</button>
    </div>
  </div>

  <!-- WAITING ROOM -->
  <div class="screen hidden" id="screen-wait">
    <div style="text-align:center">
      <div style="font-size:60px;animation:glow 2s ease-in-out infinite">üêü</div>
      <div style="font-family:'Fredoka One',cursive;font-size:28px;color:#fff;margin-top:6px">Waiting for Players</div>
    </div>
    <div class="box" style="gap:11px">
      <div class="codebox">
        <div><div class="lbl">Share this code</div><div class="gamecode" id="wait-code">----</div></div>
        <div class="sharebtns">
          <button class="copybtn" onclick="copyCode()">üìã Code</button>
          <button class="copybtn gold" onclick="shareLink()">üîó Link</button>
        </div>
      </div>
      <div class="lbl" style="margin-bottom:0">Players in room</div>
      <div class="slots" id="wait-slots"></div>
      <div id="wait-msg" class="imsg"></div>
      <button class="bigbtn bg" id="btn-start" style="display:none" onclick="startGame()">Start Game! üêü</button>
    </div>
  </div>

  <!-- GAME -->
  <div class="screen hidden" id="screen-game">
    <div id="topbar">
      <div class="schip t0">üü¢ <span id="gscore">0</span></div>
      <div id="turnbadge">...</div>
      <div class="schip t1">üîµ <span id="bscore">0</span></div>
      <button id="chat-topbtn" onclick="toggleChat()" style="
        background:rgba(255,255,255,.15); border:none; border-radius:20px;
        color:#fff; font-size:13px; font-weight:900; padding:5px 11px;
        cursor:pointer; display:flex; align-items:center; gap:5px;
        position:relative; flex-shrink:0;">
        üí¨ <span id="chat-unread2" style="display:none;background:#e74c3c;color:#fff;
          font-size:9px;padding:1px 5px;border-radius:8px;font-weight:900;"></span>
      </button>
    </div>
    <div id="table">
      <div id="claimedarea"></div>
      <div id="centerinfo">
        <div class="actionbox" id="lastaction">Game on!</div>
      </div>
    </div>
    <div id="handsec"><div id="handscroll"></div></div>
    <div id="actionpanel">
      <div id="logline"></div>
      <div class="btnrow">
        <button class="btn btn-gold" id="btn-claim" onclick="startCall()">üì£ Call</button>
        <button class="btn btn-dark" onclick="showRules()">üìñ Rules</button>
        <button class="btn btn-dark" id="btn-share" onclick="shareLink()" style="display:none">üîó Share</button>
      </div>
      <!-- Step 1: cards to ask for -->
      <div id="askable-section" style="display:none">
        <div class="askable-label" id="askable-label">Cards you can ask for:</div>
        <div id="askable-cards"></div>
      </div>
      <!-- Step 2: who to ask -->
      <div id="opp-section" style="display:none">
        <div class="opp-label" id="opp-label">Ask who?</div>
        <div id="opp-btns"></div>
      </div>
      <div id="pmsg-area"></div>
    </div>
  </div>

</div>

<!-- Chat button (shown during game) -->
<button id="chat-btn" onclick="toggleChat()">
  üí¨
  <span class="cbadge2" id="chat-unread"></span>
</button>

<!-- Chat panel -->
<div id="chat-panel">
  <div id="chat-header">
    <span>üí¨ Game Chat</span>
    <button id="chat-close" onclick="toggleChat()">‚úï</button>
  </div>
  <div id="chat-messages"></div>
  <div id="chat-input-row">
    <input id="chat-input" type="text" placeholder="Type a message..." maxlength="200"
      onkeydown="if(event.key==='Enter')sendChat()">
    <button id="chat-send" onclick="sendChat()">‚û§</button>
  </div>
</div>

<!-- Announcement banner -->
<div id="announce"></div>

<!-- Call Modal -->
<div id="call-modal">
  <div id="call-box">
    <h3 id="call-title">üì£ Make a Call</h3>
    <div id="call-content"></div>
  </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden">
  <div class="modalbox">
    <h2 id="modal-title"></h2>
    <p id="modal-body"></p>
    <button class="btn btn-gold" onclick="closeModal()">OK</button>
  </div>
</div>
<div id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE CONFIG ‚Äî baked in
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyDVfo6UiFZdwNftPH9ki7MQ6OT4hQ15gcY",
  authDomain: "fish-aace3.firebaseapp.com",
  databaseURL: "https://fish-aace3-default-rtdb.firebaseio.com",
  projectId: "fish-aace3",
  storageBucket: "fish-aace3.firebasestorage.app",
  messagingSenderId: "790749527513",
  appId: "1:790749527513:web:78d85b9544c2a8a7466dc8",
  measurementId: "G-EV607RJCM6"
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONSTANTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUITS = ['‚ô†','‚ô•','‚ô¶','‚ô£'];
const SNAMES = {'‚ô†':'Spades','‚ô•':'Hearts','‚ô¶':'Diamonds','‚ô£':'Clubs'};
const SCLASS = {'‚ô†':'c-spades','‚ô•':'c-hearts','‚ô¶':'c-diamonds','‚ô£':'c-clubs','B':'c-joker-bw','C':'c-joker-col','8':'c-eights'};
const RLOW  = ['2','3','4','5','6','7'];
const RHIGH = ['9','10','J','Q','K','A'];
const HALFSUITS = [];
for (const s of SUITS) {
  HALFSUITS.push({ id:`low-${s}`,  name:`Low ${SNAMES[s]}`,  ranks:RLOW,  suit:s });
  HALFSUITS.push({ id:`high-${s}`, name:`High ${SNAMES[s]}`, ranks:RHIGH, suit:s });
}
// Special set: all four 8s + Black/White Joker + Colored Joker = 1 half-suit of 6
HALFSUITS.push({ id:'eights-jokers', name:'8s & Jokers', suit:'8', special:true,
  cards:['8‚ô†','8‚ô•','8‚ô¶','8‚ô£','üÉèB','üÉèC']
});
const EMOJIS = ['üòé','üê±','ü¶ä','üê∏','üå∏','‚ö°','üêß','ü¶Å','üêº','ü¶ã','üé∏','üåä'];
// Positions computed dynamically in placePlayers()
const TPOS = []; // unused - see placePlayers()

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let db = null, gameCode = null, myId = null, myTeam = 0, myName = '';
let selectedCard = null, roomListener = null, isDemo = false;
let demoRoom = null, demoInterval = null;
let announceTimer = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initFB() {
  try {
    if (!firebase.apps.length) firebase.initializeApp(FIREBASE_CONFIG);
    db = firebase.database();
    return true;
  } catch(e) { console.error(e); return false; }
}
function rref(code) { return db.ref(`fish/${code}`); }
async function dbGet(code) {
  try { return (await rref(code).once('value')).val(); } catch(e) { return null; }
}
async function dbSet(code, data) { await rref(code).set(data); }
async function dbUpdate(code, updates) { await rref(code).update(updates); }
function dbListen(code, cb) {
  if (roomListener) roomListener.off();
  roomListener = rref(code);
  roomListener.on('value', s => cb(s.val()));
}
function dbUnlisten() { if (roomListener) { roomListener.off(); roomListener = null; } }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DECK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildDeck() {
  const d = [];
  for (const s of SUITS) {
    for (const r of RLOW)  d.push({rank:r, suit:s, hs:`low-${s}`});
    for (const r of RHIGH) d.push({rank:r, suit:s, hs:`high-${s}`});
    // K‚ô• is included in RHIGH above ‚Äî no special handling needed
  }
  // 8s: all four suits go into eights-jokers half-suit
  for (const s of SUITS) {
    d.push({rank:'8', suit:s, hs:'eights-jokers'});
  }
  // 2 Jokers
  d.push({rank:'üÉè', suit:'B', hs:'eights-jokers', isJoker:true}); // Black/White joker
  d.push({rank:'üÉè', suit:'C', hs:'eights-jokers', isJoker:true}); // Colored joker
  return d;
}
function shuffle(a) {
  const b=[...a];
  for(let i=b.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[b[i],b[j]]=[b[j],b[i]];}
  return b;
}
function ck(c) { return `${c.rank}${c.suit}`; }
function csort(a,b) {
  const o=HALFSUITS.map(h=>h.id);
  const d=o.indexOf(a.hs)-o.indexOf(b.hs); if(d) return d;
  const r=['2','3','4','5','6','7','8','9','10','J','Q','K','A','üÉè'];
  return r.indexOf(a.rank)-r.indexOf(b.rank);
}
function norm(h) { if(!h) return []; return (Array.isArray(h)?h:Object.values(h)).filter(Boolean); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREENS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.toggle('hidden',s.id!==id));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOBBY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let createTeam=0;
function pickTeam(t) {
  createTeam=t;
  document.getElementById('tbtn0').classList.toggle('sel',t===0);
  document.getElementById('tbtn1').classList.toggle('sel',t===1);
}
pickTeam(0);

function genCode() {
  const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let s=''; for(let i=0;i<4;i++) s+=c[Math.floor(Math.random()*c.length)];
  return s;
}
function randEmoji() { return EMOJIS[Math.floor(Math.random()*EMOJIS.length)]; }

async function createGame() {
  const name = document.getElementById('create-name').value.trim();
  if (!name) { toast('Enter your name!'); return; }
  gameCode=genCode(); myId=0; myTeam=createTeam; myName=name; isDemo=false;
  const room = {
    code:gameCode, phase:'lobby',
    players:{0:{id:0,name,team:createTeam,emoji:randEmoji(),ready:true}},
    hands:{0:[],1:[],2:[],3:[],4:[],5:[]},
    currentPlayer:0, claimed:[], lastAction:'Waiting for players...',
    greenScore:0, blueScore:0, logs:['Room created!'], creator:0, playerCount:1,
  };
  await dbSet(gameCode,room);
  updateUrlCode(gameCode);
  saveSession();
  toast('‚úÖ Room created!');
  showWaiting();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JOIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let joinTeam=0, joinCodeVal='';
function pickJoinTeam(t) {
  joinTeam=t;
  document.getElementById('join-tbtn0').classList.toggle('sel',t===0);
  document.getElementById('join-tbtn1').classList.toggle('sel',t===1);
}

function goJoin() {
  const raw=document.getElementById('join-code-input').value.trim();
  const code=raw.replace(/[^A-Z0-9]/gi,'').toUpperCase().slice(0,6);
  if (code.length<4) { toast('Enter a 4-letter code!'); return; }
  joinCodeVal=code;
  document.getElementById('join-code-display').textContent=code;
  pickJoinTeam(0);
  showScreen('screen-join');
  refreshJoinRoom();
}

async function refreshJoinRoom() {
  const msg=document.getElementById('join-msg');
  const slotsEl=document.getElementById('join-slots');
  msg.textContent='Looking up room...'; msg.className='imsg';
  const room=await dbGet(joinCodeVal);
  if (!room) {
    msg.textContent=`‚ùå Room "${joinCodeVal}" not found. Have the host create a room first!`;
    msg.className='imsg err'; slotsEl.innerHTML='';
    document.getElementById('btn-join-confirm').disabled=true; return;
  }
  if (room.phase!=='lobby') {
    msg.textContent='‚ö†Ô∏è Game already started!'; msg.className='imsg warn';
    document.getElementById('btn-join-confirm').disabled=true; return;
  }
  const players=Object.values(room.players||{});
  renderSlots(slotsEl,players);
  const count=players.length;
  const g=players.filter(p=>p.team===0).length;
  const b=players.filter(p=>p.team===1).length;
  if (count>=6) {
    msg.textContent='‚ö†Ô∏è Room full (6/6)'; msg.className='imsg warn';
    document.getElementById('btn-join-confirm').disabled=true;
  } else {
    msg.textContent=`${count}/6 ¬∑ üü¢ ${g}/3 Green ¬∑ üîµ ${b}/3 Blue`; msg.className='imsg';
    document.getElementById('btn-join-confirm').disabled=false;
  }
}

async function joinGame() {
  const name=document.getElementById('join-name').value.trim();
  if (!name) { toast('Enter your name!'); return; }
  const room=await dbGet(joinCodeVal);
  if (!room) { toast('Room not found!'); return; }
  if (room.phase!=='lobby') { toast('Game already started!'); return; }
  const players=Object.values(room.players||{});
  if (players.length>=6) { toast('Room is full!'); return; }
  const teamCount=players.filter(p=>p.team===joinTeam).length;
  if (teamCount>=3) { toast(`${joinTeam===0?'üü¢ Green':'üîµ Blue'} team is full (3/3)! Pick the other team.`); return; }
  myId=players.length; myTeam=joinTeam; myName=name; gameCode=joinCodeVal; isDemo=false;
  await rref(gameCode).child('players').child(String(myId)).set({id:myId,name,team:joinTeam,emoji:randEmoji(),ready:true});
  await rref(gameCode).child('playerCount').set(myId+1);
  updateUrlCode(gameCode);
  saveSession();
  showWaiting();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WAITING ROOM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showWaiting() {
  document.getElementById('wait-code').textContent=gameCode;
  showScreen('screen-wait');
  let autoStart=null;

  dbListen(gameCode, room => {
    if (!room) return;
    if (room.phase==='game'||room.phase==='over') {
      dbUnlisten(); if(autoStart){clearInterval(autoStart);autoStart=null;}
      const me=room.players&&room.players[myId];
      if(me){myTeam=me.team;myName=me.name;}
      enterGame(room); return;
    }
    const players=Object.values(room.players||{});
    renderSlots(document.getElementById('wait-slots'),players);
    const count=players.length;
    const msg=document.getElementById('wait-msg');
    const startBtn=document.getElementById('btn-start');

    if (count>=6) {
      startBtn.style.display='block'; startBtn.textContent='Start Now! üêü';
      msg.textContent='6/6 ¬∑ Full!'; msg.className='imsg ok';
      if (myId===0&&!autoStart) {
        let secs=5;
        autoStart=setInterval(async()=>{
          secs--;
          const r2=await dbGet(gameCode);
          if(!r2||r2.phase!=='lobby'){clearInterval(autoStart);autoStart=null;return;}
          msg.textContent=`6/6 ¬∑ Starting in ${secs}s...`;
          if(secs<=0){clearInterval(autoStart);autoStart=null;startGame();}
        },1000);
      }
    } else {
      if(autoStart){clearInterval(autoStart);autoStart=null;}
      msg.textContent=count>=2?`${count}/6 ¬∑ Ready to start!`:`${count}/6 ¬∑ Need at least 2`;
      msg.className=count>=2?'imsg ok':'imsg';
      startBtn.style.display=(myId===0&&count>=2)?'block':'none';
      if(myId===0&&count>=2) startBtn.textContent=`Start with ${count} üêü`;
    }
  });
}

async function startGame() {
  const room=await dbGet(gameCode);
  if(!room||room.phase!=='lobby') return;
  const active=Object.values(room.players||{});
  const n=active.length;
  if(n<2){toast('Need at least 2!');return;}
  const deck=shuffle(buildDeck());
  const pp=Math.floor(deck.length/n);
  const hands={};
  for(let i=0;i<6;i++) hands[i]=[];
  active.forEach(p=>{hands[p.id]=deck.splice(0,pp).sort(csort);});
  await dbSet(gameCode,{...room,hands,phase:'game',currentPlayer:active[0].id,
    claimed:[],greenScore:0,blueScore:0,
    lastAction:`${active[0].name} goes first!`,logs:['Game started!']});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME SCREEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function enterGame(init) {
  showScreen('screen-game');
  document.getElementById('btn-share').style.display=isDemo?'none':'block';
  showChatBtn(true);
  if (!isDemo) { listenChat(); startKeepAlive(); saveSession(); }
  else { addSystemMsg('üí¨ Chat disabled in demo mode'); }
  renderGame(init);
  if(!isDemo) {
    dbListen(gameCode, room=>{
      if(!room) return;
      renderGame(room);
      if(room.phase==='over') {
        dbUnlisten();
        const w=room.greenScore>room.blueScore?'üü¢ Green':room.blueScore>room.greenScore?'üîµ Blue':null;
        setTimeout(()=>showModal('üêü Game Over!',
          w?`${w} team wins ${room.greenScore}‚Äì${room.blueScore}!`:`Tie! ${room.greenScore}‚Äì${room.blueScore}`),600);
      }
    });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PLAYER PLACEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//
//  Exact layout (6 players):
//
//   [P2: top-left]   [P1: top-center]   [P3: top-right]
//
//   [P4: mid-left]                       [P5: mid-right]
//
//                   [P0: ME - bottom]
//
// Each position is fully separated - no overlapping possible.
// Teams alternate: Green(0), Blue(1), Green(0), Blue(1)...

const SLOT_POS = [
  { left:'50.0%', top:'78.0%', bottom:'auto', transform:'translate(-50%,-50%)' }, // ME
  { left:'78.6%', top:'63.0%', bottom:'auto', transform:'translate(-50%,-50%)' }, // bottom-right
  { left:'78.6%', top:'33.0%', bottom:'auto', transform:'translate(-50%,-50%)' }, // top-right
  { left:'50.0%', top:'18.0%', bottom:'auto', transform:'translate(-50%,-50%)' }, // top
  { left:'21.4%', top:'33.0%', bottom:'auto', transform:'translate(-50%,-50%)' }, // top-left
  { left:'21.4%', top:'63.0%', bottom:'auto', transform:'translate(-50%,-50%)' }, // bottom-left
];

function makePTok(player, pos, hc, active, isOpp, myTurn) {
  const cardCount = hc ? (Array.isArray(hc) ? hc.length : Object.keys(hc).length) : 0;
  const isMe = Number(player.id) === Number(myId);

  const div = document.createElement('div');
  div.className = 'ptok';
  div.style.cssText = `position:absolute; left:${pos.left}; top:${pos.top}; bottom:${pos.bottom||'auto'}; transform:translate(-50%,-50%); z-index:5; display:flex; flex-direction:column; align-items:center; gap:4px;`;

  const av = document.createElement('div');
  av.className = `pav t${player.team}${active ? ' active' : ''}${isOpp && myTurn ? ' tappable' : ''}`;
  av.textContent = player.emoji || '?';

  const badge = document.createElement('span');
  badge.className = 'cbadge';
  badge.textContent = cardCount;
  av.appendChild(badge);

  if (isOpp && myTurn) {
    av.style.cursor = 'pointer';
    av.onclick = () => {
      if (selectedAskCard) {
        const c = selectedAskCard; selectedCard = null; selectedAskCard = null;
        askCard(c, player.id);
      } else if (selectedCard) {
        toast(`Pick the exact card to ask for below, then tap ${player.name}`);
      } else {
        toast('Tap a card in your hand first');
      }
    };
  }

  const tag = document.createElement('div');
  tag.className = 'ptag';
  tag.textContent = isMe ? `${player.name} (you)` : player.name;

  div.appendChild(av);
  div.appendChild(tag);
  return div;
}

function placePlayers(table, players, hands, myTurn, currentPlayer) {
  // Clear old tokens and SVG
  table.querySelectorAll('.ptok, .hex-svg').forEach(e => e.remove());

  // Draw dotted hexagon outline
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('class', 'hex-svg');
  svg.style.cssText = 'position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:2;overflow:visible';
  svg.setAttribute('viewBox', '0 0 100 100');
  svg.setAttribute('preserveAspectRatio', 'none');
  const poly = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
  // Match SLOT_POS exactly
  poly.setAttribute('points', '50.0,78.0 78.6,63.0 78.6,33.0 50.0,18.0 21.4,33.0 21.4,63.0');
  poly.setAttribute('fill', 'none');
  poly.setAttribute('stroke', 'rgba(255,255,255,0.2)');
  poly.setAttribute('stroke-width', '0.8');
  poly.setAttribute('stroke-dasharray', '2.5,2.5');
  svg.appendChild(poly);
  table.appendChild(svg);

  // Get all players as array
  const pAll = Object.values(players).filter(Boolean);
  if (!pAll.length) return;

  // Find me
  const me = pAll.find(p => Number(p.id) === Number(myId)) || pAll[0];
  // Everyone else, interleaved by team
  const others = pAll.filter(p => p.id !== me.id);
  const oppTeam  = others.filter(p => p.team !== me.team);
  const sameTeam = others.filter(p => p.team === me.team);

  // Interleave: slot1=opp, slot2=same, slot3=opp, slot4=same, slot5=opp
  const ordered = [me]; // slot 0 = me
  const max = Math.max(oppTeam.length, sameTeam.length);
  for (let i = 0; i < max; i++) {
    if (oppTeam[i])  ordered.push(oppTeam[i]);
    if (sameTeam[i]) ordered.push(sameTeam[i]);
  }

  ordered.forEach((player, i) => {
    if (i >= SLOT_POS.length) return;
    const pos = SLOT_POS[i];
    const hc = hands ? hands[player.id] : null;
    const active = Number(currentPlayer) === Number(player.id);
    const isOpp = Number(player.id) !== Number(myId) && player.team !== me.team;
    table.appendChild(makePTok(player, pos, hc, active, isOpp, myTurn));
  });
}


function renderGame(room) {
  if(!room) return;
  // Refresh session timestamp so we don't expire during long games
  if (!isDemo) saveSession();
  const players=room.players||{};
  const hands=room.hands||{};

  document.getElementById('gscore').textContent=room.greenScore||0;
  document.getElementById('bscore').textContent=room.blueScore||0;

  const curP=players[room.currentPlayer];
  const myTurn=Number(room.currentPlayer)===Number(myId);
  document.getElementById('turnbadge').textContent=myTurn?'‚≠ê Your Turn!':`${curP?curP.name:'?'}'s Turn`;
  document.getElementById('lastaction').innerHTML=room.lastAction||'';

  const logs=room.logs||[];
  document.getElementById('logline').textContent=logs[0]||'';

  // Claimed ‚Äî 2 stacked piles in center: green left, blue right
  const ca=document.getElementById('claimedarea'); ca.innerHTML='';
  const claimed=room.claimed||[];
  const greenClaimed=claimed.filter(c=>c.team===0);
  const blueClaimed =claimed.filter(c=>c.team===1);

  function makePile(teamClaimed, team) {
    const pile=document.createElement('div');
    pile.style.cssText='display:flex;flex-direction:column;align-items:center;gap:4px;min-width:60px';

    // Label
    const lbl=document.createElement('div');
    lbl.style.cssText=`font-size:9px;font-weight:900;text-transform:uppercase;letter-spacing:1px;
      color:${team===0?'#2ecc71':'#3498db'};margin-bottom:2px;`;
    lbl.textContent=team===0?'üü¢ Green':'üîµ Blue';
    pile.appendChild(lbl);

    if(!teamClaimed.length){
      const empty=document.createElement('div');
      empty.style.cssText='width:46px;height:62px;border-radius:8px;border:2px dashed rgba(255,255,255,.15);opacity:.4;display:flex;align-items:center;justify-content:center;font-size:18px';
      empty.textContent=team===0?'üü¢':'üîµ';
      pile.appendChild(empty);
      return pile;
    }

    // Single stacked pile ‚Äî all sets on top of each other with offset
    const stackWrap=document.createElement('div');
    stackWrap.style.cssText='position:relative;width:50px;';
    const stackH=62+(teamClaimed.length-1)*6;
    stackWrap.style.height=stackH+'px';

    teamClaimed.forEach((c,i)=>{
      const hs=HALFSUITS.find(h=>h.id===c.halfSuitId);
      const suitChar=hs?(hs.suit==='8'?'8Ô∏è‚É£':hs.suit):'?';
      const isLow=c.halfSuitId.startsWith('low');
      const label=hs?(hs.special?hs.name.replace('The ','').replace(' & ','&'):(isLow?'Lo':'Hi')):'?';

      const card=document.createElement('div');
      card.style.cssText=`position:absolute;
        left:0;top:${i*6}px;
        width:50px;height:62px;border-radius:8px;
        background:${team===0?'linear-gradient(135deg,#27ae60,#1a6b3a)':'linear-gradient(135deg,#2980b9,#1a5276)'};
        border:2px solid rgba(255,255,255,.3);
        display:flex;flex-direction:column;align-items:center;justify-content:center;
        box-shadow:0 3px 8px rgba(0,0,0,.5);
        animation: claimDrop .4s cubic-bezier(.34,1.56,.64,1) forwards;`;
      card.innerHTML=`<span style="font-size:18px;line-height:1">${suitChar}</span>
        <span style="font-size:9px;font-weight:900;color:rgba(255,255,255,.8);margin-top:2px">${label}</span>`;
      stackWrap.appendChild(card);
    });
    pile.appendChild(stackWrap);

    // Count badge
    const cnt=document.createElement('div');
    cnt.style.cssText='font-size:10px;font-weight:900;color:rgba(255,255,255,.7);margin-top:4px';
    cnt.textContent=`${teamClaimed.length} set${teamClaimed.length!==1?'s':''}`;
    pile.appendChild(cnt);
    return pile;
  }

  ca.appendChild(makePile(greenClaimed, 0));
  ca.appendChild(makePile(blueClaimed,  1));

  // Player tokens ‚Äî placed dynamically
  const table=document.getElementById('table');
  const plist=Object.values(players);
  placePlayers(table, players, hands, myTurn, room.currentPlayer);

  // My hand
  const rh=hands[myId];
  const myHand=rh?(Array.isArray(rh)?rh:Object.values(rh)).filter(Boolean):[];
  renderHand(myHand);
  renderActionPanel(room,myHand,myTurn,plist);
}

function jokerSVG(isBW) {
  // Colors
  const ink    = isBW ? '#111' : '#111';
  const hat1   = isBW ? '#111' : '#1a1a1a';    // dark part of hat
  const hat2   = isBW ? '#555' : '#f1c40f';    // light part of hat
  const body1  = isBW ? '#111' : '#c0392b';    // dark costume
  const body2  = isBW ? '#ddd' : '#f1c40f';    // light costume
  const skin   = isBW ? '#eee' : '#f5cba7';
  const heart  = '#c0392b';
  const spade  = isBW ? '#111' : '#111';

  return `<svg viewBox="0 0 60 90" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%">
    <!-- Hat with 3 bells -->
    <polygon points="30,18 22,8 18,16" fill="${hat1}"/>
    <polygon points="30,18 38,8 42,16" fill="${hat2}"/>
    <polygon points="25,20 35,20 30,8" fill="${hat1}"/>
    <circle cx="18" cy="17" r="2.5" fill="${hat2}" stroke="${ink}" stroke-width="0.5"/>
    <circle cx="42" cy="17" r="2.5" fill="${hat1}" stroke="${ink}" stroke-width="0.5"/>
    <circle cx="30" cy="7"  r="2.5" fill="${hat2}" stroke="${ink}" stroke-width="0.5"/>
    <!-- Face -->
    <ellipse cx="30" cy="26" rx="9" ry="10" fill="${skin}" stroke="${ink}" stroke-width="0.8"/>
    <circle cx="26.5" cy="24" r="1.2" fill="${ink}"/>
    <circle cx="33.5" cy="24" r="1.2" fill="${ink}"/>
    <path d="M26,30 Q30,33 34,30" stroke="${ink}" stroke-width="0.8" fill="none" stroke-linecap="round"/>
    <ellipse cx="30" cy="26" rx="2.5" ry="1.5" fill="${body1}" opacity="0.3"/>
    <!-- Collar / ruffle -->
    <path d="M21,35 Q25,31 30,33 Q35,31 39,35" stroke="${ink}" stroke-width="0.6" fill="${body2}" opacity="0.9"/>
    <!-- Body / costume -->
    <path d="M22,35 L20,58 L30,55 L40,58 L38,35 Z" fill="${body1}"/>
    <path d="M22,35 L24,58 L30,55 L36,58 L38,35 Z" fill="${body2}" opacity="0.7"/>
    <!-- Skirt / tutu -->
    <path d="M18,52 Q21,47 25,51 Q28,46 30,51 Q32,46 35,51 Q39,47 42,52 L40,58 L20,58 Z" fill="${body2}" stroke="${ink}" stroke-width="0.5"/>
    <!-- Arms -->
    <line x1="22" y1="40" x2="10" y2="46" stroke="${ink}" stroke-width="2" stroke-linecap="round"/>
    <line x1="38" y1="40" x2="50" y2="46" stroke="${ink}" stroke-width="2" stroke-linecap="round"/>
    <!-- Hands -->
    <circle cx="10" cy="47" r="2.5" fill="${skin}" stroke="${ink}" stroke-width="0.5"/>
    <circle cx="50" cy="47" r="2.5" fill="${skin}" stroke="${ink}" stroke-width="0.5"/>
    <!-- Juggling suits -->
    <text x="6"  y="40" font-size="5" fill="${heart}" text-anchor="middle">‚ô•</text>
    <text x="15" y="32" font-size="5" fill="${spade}" text-anchor="middle">‚ô†</text>
    <text x="45" y="32" font-size="5" fill="${heart}" text-anchor="middle">‚ô¶</text>
    <text x="54" y="40" font-size="5" fill="${spade}" text-anchor="middle">‚ô£</text>
    <!-- Legs -->
    <line x1="26" y1="58" x2="24" y2="72" stroke="${ink}" stroke-width="2.5" stroke-linecap="round"/>
    <line x1="34" y1="58" x2="38" y2="72" stroke="${ink}" stroke-width="2.5" stroke-linecap="round"/>
    <!-- Shoes -->
    <ellipse cx="22" cy="73" rx="5" ry="2" fill="${hat1}" transform="rotate(-10,22,73)"/>
    <ellipse cx="40" cy="73" rx="5" ry="2" fill="${hat2}" transform="rotate(10,40,73)"/>
  </svg>`;
}

function makeCardHTML(rank, suit, suitClass) {
  if (rank === 'üÉè') {
    const isBW = suit === 'B';
    const textCol = isBW ? '#111' : '#c0392b';
    const cardBg  = '#fffef8';
    return '<div style="position:relative;width:100%;height:100%;background:' + cardBg + ';border-radius:4px;overflow:hidden;">'
      + '<div style="position:absolute;top:2px;left:3px;font-family:serif;font-size:7px;font-weight:900;color:' + textCol + ';letter-spacing:-0.5px;line-height:1.15">J<br>O<br>K<br>E<br>R</div>'
      + '<div style="position:absolute;bottom:2px;right:3px;font-family:serif;font-size:7px;font-weight:900;color:' + textCol + ';letter-spacing:-0.5px;line-height:1.15;transform:rotate(180deg)">J<br>O<br>K<br>E<br>R</div>'
      + '<div style="position:absolute;inset:0;padding:2px 10px 2px 10px">' + jokerSVG(isBW) + '</div>'
      + '</div>';
  }
  const s = suit;
  return '<div class="corner-tl"><span class="c-rank">' + rank + '</span><span class="c-suit">' + s + '</span></div>'
       + '<span class="c-center">' + s + '</span>';
}

function cardSuitClass(card) {
  if (card.rank === 'üÉè') return card.suit === 'B' ? 'c-joker-bw' : 'c-joker-col';
  if (card.hs === 'eights-jokers') return 'c-eights ' + (SCLASS[card.suit] || 'c-spades');
  return SCLASS[card.suit] || 'c-spades';
}

function renderHand(hand) {
  const c=document.getElementById('handscroll'); c.innerHTML='';
  hand.forEach(card=>{
    const sc = cardSuitClass(card);
    const el=document.createElement('div');
    el.className='card ' + sc + (selectedCard&&ck(selectedCard)===ck(card)?' sel':'');
    el.innerHTML=makeCardHTML(card.rank, card.suit, sc);
    el.onclick=()=>{
      selectedCard=(selectedCard&&ck(selectedCard)===ck(card))?null:card;
      selectedAskCard=null;
      renderHand(hand);
      buildAskOpts(null,hand);
    };
    c.appendChild(el);
  });
}

function renderActionPanel(room,myHand,myTurn,plist) {
  const claimBtn=document.getElementById('btn-claim');
  claimBtn.disabled=!myTurn; claimBtn.className=myTurn?'btn btn-gold':'btn btn-dark';

  if(!myTurn) {
    // Hide ask UI, show waiting msg
    document.getElementById('askable-section').style.display='none';
    document.getElementById('opp-section').style.display='none';
    const pm=document.getElementById('pmsg-area'); pm.innerHTML='';
    const cur=(room.players||{})[room.currentPlayer];
    const m=document.createElement('div'); m.className='pmsg';
    m.textContent=cur?`Waiting for ${cur.name}...`:'Waiting...';
    pm.appendChild(m);
    return;
  }
  refreshAskUI(myHand, room, plist);
}

// selectedAskCard = the specific card chosen to ask for (step 2)
let selectedAskCard = null;

function buildAskOpts(container, myHand, room, plist) {
  // container is unused now ‚Äî we use dedicated sections
  refreshAskUI(myHand, room, plist);
}

function refreshAskUI(myHand, room, plist) {
  const askSec   = document.getElementById('askable-section');
  const oppSec   = document.getElementById('opp-section');
  const pmsgArea = document.getElementById('pmsg-area');
  const askCards = document.getElementById('askable-cards');
  const oppBtns  = document.getElementById('opp-btns');
  const askLbl   = document.getElementById('askable-label');
  const oppLbl   = document.getElementById('opp-label');
  pmsgArea.innerHTML=''; askSec.style.display='none'; oppSec.style.display='none';

  if (!selectedCard) {
    const m=document.createElement('div'); m.className='pmsg';
    m.textContent='üëÜ Tap a card in your hand'; pmsgArea.appendChild(m); return;
  }

  const hsId=selectedCard.hs;
  const hs=HALFSUITS.find(h=>h.id===hsId);
  const mine=new Set(myHand.filter(c=>c.hs===hsId).map(c=>ck(c)));
  // Use getAllHsCards so special sets (eights-jokers) work correctly
  const allHsCards = getAllHsCards(hs);
  const askable = allHsCards.filter(c=>!mine.has(ck(c)));

  if (!askable.length) {
    const m=document.createElement('div'); m.className='pmsg';
    m.textContent=`‚úÖ You have all of ${hs.name}! Tap üèÜ Claim.`; pmsgArea.appendChild(m); return;
  }

  // Step 1 ‚Äî show askable cards
  askLbl.textContent=`${hs.name} ‚Äî which card to ask for?`;
  askCards.innerHTML='';
  askable.forEach(card=>{
    const el=document.createElement('div');
    const _asc = cardSuitClass(card);
    el.className='acard ' + _asc + (selectedAskCard&&ck(selectedAskCard)===ck(card)?' chosen':'');
    el.innerHTML = makeCardHTML(card.rank, card.suit, _asc)
      .replace('class="corner-tl"','class="ac-tl"')
      .replace('class="corner-br"','class="ac-br"')
      .replace('class="c-rank"','class="ac-r"')
      .replace(/class="c-suit"/g,'class="ac-s"')
      .replace('class="c-center"','class="ac-center"');
    el.onclick=()=>{
      selectedAskCard=(selectedAskCard&&ck(selectedAskCard)===ck(card))?null:card;
      refreshAskUI(myHand, room, plist);
    };
    askCards.appendChild(el);
  });
  askSec.style.display='block';

  // Step 2 ‚Äî if a card is chosen, show opponent buttons
  if (!selectedAskCard) return;
  const opps=(plist||[]).filter(p=>p&&p.team!==myTeam);
  if (!opps.length) return;

  const hands=room?(room.hands||{}):null;
  oppLbl.innerHTML=`Ask for <b>${selectedAskCard.rank}${selectedAskCard.suit}</b> from: <span style="opacity:.6;font-weight:700;font-size:9px">(or tap their avatar above)</span>`;
  oppBtns.innerHTML='';
  opps.forEach(opp=>{
    const b=document.createElement('button'); b.className='oppbtn';
    const cardCount=hands?(norm(hands[opp.id]).length):0;
    b.innerHTML=`<span style="font-size:18px">${opp.emoji}</span><span class="oname">${opp.name}</span><span class="ocount">${cardCount} cards</span>`;
    b.onclick=()=>{
      const cardToAsk=selectedAskCard;
      selectedCard=null; selectedAskCard=null;
      askCard(cardToAsk, opp.id);
    };
    oppBtns.appendChild(b);
  });
  oppSec.style.display='block';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ANNOUNCE ‚Äî shows to everyone
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastAnnounced = '';
function announce(html) {
  // Deduplicate ‚Äî don't re-announce same event
  if (html === lastAnnounced) return;
  lastAnnounced = html;
  const el=document.getElementById('announce');
  el.innerHTML=html; el.classList.add('show');
  if(announceTimer) clearTimeout(announceTimer);
  announceTimer=setTimeout(()=>{ el.classList.remove('show'); },3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function askCard(card,targetId) {
  if(isDemo){demoAskCard(card,targetId);return;}
  const room=await dbGet(gameCode);
  if(!room||room.phase!=='game') return;
  if(room.currentPlayer!==myId){toast("Not your turn!");return;}
  const players=room.players||{};
  const tp=players[targetId];
  if(!tp||tp.team===myTeam){toast('Can only ask opponents!');return;}
  const myHand=norm(room.hands[myId]);
  if(!myHand.some(c=>c.hs===card.hs)){toast('Need a card in that half-suit!');return;}
  if(myHand.some(c=>ck(c)===ck(card))){toast('You already have that!');return;}
  const tHand=norm(room.hands[targetId]);
  const hasIt=tHand.some(c=>ck(c)===ck(card));
  const logs=Array.isArray(room.logs)?[...room.logs]:[];
  let updates={};
  let annHtml='';

  if(hasIt) {
    const newT=tHand.filter(c=>ck(c)!==ck(card));
    const newM=[...myHand,card].sort(csort);
    updates[`hands/${targetId}`]=newT;
    updates[`hands/${myId}`]=newM;
    updates['lastAction']=`<span class="yes">‚úÖ Got it!</span><br>${myName} took ${card.rank}${card.suit} from ${tp.name}`;
    logs.unshift(`${myName} took ${card.rank}${card.suit} from ${tp.name}`);
    annHtml=`<span class="ann-yes">‚úÖ ${myName}</span> took <b>${card.rank}${card.suit}</b> from <b>${tp.name}</b>!`;
  } else {
    let next=targetId;
    for(let i=0;i<6;i++){if(norm(room.hands[next]).length>0) break; next=(next+1)%6;}
    updates['currentPlayer']=next;
    updates['lastAction']=`<span class="no">‚ùå Go Fish!</span><br>${tp.name} doesn't have ${card.rank}${card.suit}`;
    logs.unshift(`${myName} asked ${tp.name} for ${card.rank}${card.suit} ‚Äî nope`);
    annHtml=`<span class="ann-no">‚ùå ${tp.name}</span> didn't have <b>${card.rank}${card.suit}</b> ‚Äî turn passes`;
  }
  updates['logs']=logs.slice(0,20);
  updates['announcement']=annHtml; // broadcast to all players
  selectedCard=null; selectedAskCard=null;
  await dbUpdate(gameCode,updates);
}

// startCall ‚Äî the new call system (replaces startClaim)
async function startCall() {
  if (isDemo) { openCallModal(demoRoom, false); return; }
  const room = await dbGet(gameCode);
  if (!room || room.phase !== 'game') return;
  openCallModal(room, true);
}

// ‚îÄ‚îÄ Call modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openCallModal(room, isMulti) {
  if (!room) return;
  if (Number(room.currentPlayer) !== Number(myId)) { toast("It's not your turn!"); return; }

  const players  = room.players || {};
  const hands    = room.hands   || {};
  const teammates = Object.values(players).filter(p => Number(p.id) !== Number(myId) && p.team === myTeam);
  const teamIds   = [myId, ...teammates.map(p => p.id)];

  const callableHs = HALFSUITS.filter(hs => {
    if ((room.claimed||[]).some(c => c.halfSuitId === hs.id)) return false;
    return teamIds.some(pid => norm(hands[pid]).some(c => c.hs === hs.id));
  });

  if (!callableHs.length) { toast("Your team has no cards to call on!"); return; }

  const modal   = document.getElementById('call-modal');
  const content = document.getElementById('call-content');
  document.getElementById('call-title').textContent = 'üì£ Call ‚Äî Assign Every Card';
  content.innerHTML = '';

  let selectedHs  = callableHs[0];
  let assignments = {};

  function renderModal() {
    content.innerHTML = '';

    // Half-suit selector
    const hsLabel = document.createElement('div');
    hsLabel.style.cssText = 'color:rgba(255,255,255,.5);font-size:10px;font-weight:900;letter-spacing:1px;text-transform:uppercase;margin-bottom:6px';
    hsLabel.textContent = 'Pick half-suit:';
    content.appendChild(hsLabel);

    const hsRow = document.createElement('div');
    hsRow.style.cssText = 'display:flex;gap:6px;flex-wrap:wrap;margin-bottom:14px';
    callableHs.forEach(hs => {
      const btn = document.createElement('button');
      btn.className = 'call-hs-btn' + (hs.id === selectedHs.id ? ' active' : '');
      btn.innerHTML = `${hs.suit === '8' ? '8Ô∏è‚É£' : hs.suit === 'üÉè' ? 'üÉè' : hs.suit} ${hs.name}`;
      btn.onclick = () => { selectedHs = hs; assignments = {}; renderModal(); };
      hsRow.appendChild(btn);
    });
    content.appendChild(hsRow);

    const allCards = getAllHsCards(selectedHs);
    const allPlayers = [players[myId], ...teammates];

    // Only pre-select cards YOU personally hold ‚Äî teammates are free choice
    allCards.forEach(card => {
      const key = ck(card);
      if (assignments[key] !== undefined) return;
      if (norm(hands[myId]).some(c => ck(c) === key)) assignments[key] = myId;
    });

    // Card assignment rows
    allCards.forEach(card => {
      const key = ck(card);
      const row = document.createElement('div');
      row.style.cssText = 'display:flex;align-items:center;gap:8px;margin-bottom:10px';

      // Card chip
      const chip = document.createElement('div');
      const isRed    = card.suit==='‚ô•'||card.suit==='‚ô¶';
      const isJoker  = card.isJoker;
      const isEight  = card.rank==='8';
      let bg = '#fff', col = isRed ? '#c0392b' : '#1a1a2e';
      if (isJoker && card.suit==='B') { bg='linear-gradient(135deg,#222,#555)'; col='#fff'; }
      if (isJoker && card.suit==='C') { bg='linear-gradient(135deg,#e74c3c,#f39c12,#2ecc71,#3498db)'; col='#fff'; }
      if (isEight)                    { bg='linear-gradient(135deg,#f39c12,#d35400)'; col='#fff'; }
      const dispRank = isJoker ? 'üÉè' : card.rank;
      const dispSuit = isJoker ? (card.suit==='B'?'BW':'üåà') : card.suit;
      chip.style.cssText = `width:42px;height:56px;border-radius:7px;background:${bg};border:1.5px solid rgba(255,255,255,.3);
        display:flex;flex-direction:column;justify-content:space-between;padding:3px;flex-shrink:0;position:relative`;
      chip.innerHTML = `<div style="color:${col};font-size:11px;font-weight:900;font-family:'Fredoka One',cursive;line-height:1">${dispRank}<br><span style="font-size:8px">${dispSuit}</span></div>
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:13px;color:${col}">${isJoker?'üÉè':card.suit}</div>
        <div style="color:${col};font-size:11px;font-weight:900;font-family:'Fredoka One',cursive;line-height:1;transform:rotate(180deg)">${dispRank}</div>`;
      row.appendChild(chip);

      // Player btns
      const selRow = document.createElement('div');
      selRow.style.cssText = 'display:flex;gap:5px;flex-wrap:wrap;flex:1';
      allPlayers.forEach(p => {
        if (!p) return;
        const isSelected = Number(assignments[key]) === Number(p.id);
        const btn = document.createElement('button');
        btn.style.cssText = `padding:6px 10px;border-radius:10px;
          border:2px solid ${isSelected?'#f1c40f':'rgba(255,255,255,.18)'};
          background:${isSelected?'rgba(241,196,15,.2)':'rgba(255,255,255,.07)'};
          color:#fff;cursor:pointer;font-size:12px;font-weight:900;
          font-family:'Nunito',sans-serif;transition:all .15s`;
        btn.textContent = `${p.emoji||'?'} ${Number(p.id)===Number(myId)?'Me':p.name}`;
        btn.onclick = () => { assignments[key] = p.id; renderModal(); };
        selRow.appendChild(btn);
      });
      row.appendChild(selRow);
      content.appendChild(row);
    });

    const allAssigned = allCards.every(c => assignments[ck(c)] !== undefined);

    const confirmBtn = document.createElement('button');
    confirmBtn.className = 'call-confirm-btn';
    confirmBtn.style.marginTop = '8px';
    confirmBtn.textContent = allAssigned ? 'üì£ Make the Call!' : `Assign all ${allCards.length} cards first`;
    confirmBtn.disabled = !allAssigned;
    confirmBtn.style.opacity = allAssigned ? '1' : '0.5';
    confirmBtn.onclick = () => {
      if (!allAssigned) return;
      closeCallModal();
      resolveCall(room, selectedHs, {...assignments}, isMulti);
    };
    content.appendChild(confirmBtn);

    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'call-cancel-btn';
    cancelBtn.style.marginTop = '6px';
    cancelBtn.textContent = '‚úï Cancel';
    cancelBtn.onclick = closeCallModal;
    content.appendChild(cancelBtn);
  }

  renderModal();
  modal.classList.add('open');
}

function getAllHsCards(hs) {
  if (hs.cards) {
    return hs.cards.map(key => {
      if (key.startsWith('üÉè')) {
        // key is 'üÉèB' or 'üÉèC' ‚Äî use endsWith to be safe with emoji byte length
        const suit = key.endsWith('B') ? 'B' : 'C';
        return {rank:'üÉè', suit, hs:hs.id, isJoker:true};
      }
      // Regular card like '8‚ô†' ‚Äî last char is suit, rest is rank
      const suit = key.slice(-1), rank = key.slice(0, -1);
      return {rank, suit, hs:hs.id};
    });
  }
  return hs.ranks.map(r => ({rank:r, suit:hs.suit, hs:hs.id}));
}

function closeCallModal() {
  document.getElementById('call-modal').classList.remove('open');
}

async function resolveCall(room, hs, assignments, isMulti) {
  const players = room.players || {};
  const hands   = room.hands   || {};
  const allCards = getAllHsCards(hs);
  let wrong = 0; const errors = [];

  allCards.forEach(card => {
    const key = ck(card);
    const calledPid = assignments[key];
    const actualHolder = Object.values(players).find(p => norm(hands[p.id]).some(c => ck(c) === key));
    const actualPid = actualHolder ? Number(actualHolder.id) : null;
    if (actualPid !== null && Number(calledPid) !== actualPid) {
      wrong++;
      errors.push(`${card.rank}${card.suit}: called ${(players[calledPid]||{}).name||'?'}, had ${actualHolder.name}`);
    }
  });

  const callingTeam = myTeam;
  const callingTeamName = callingTeam===0 ? 'üü¢ Green' : 'üîµ Blue';
  const oppTeamName     = callingTeam===0 ? 'üîµ Blue'  : 'üü¢ Green';
  const oppTeamIds      = Object.values(players).filter(p => p.team !== callingTeam).map(p => p.id);
  const oppHoldsCard    = allCards.some(card => oppTeamIds.some(pid => norm(hands[pid]).some(c => ck(c) === ck(card))));

  let winner, reason;
  if (oppHoldsCard) {
    winner = 1 - callingTeam;
    reason = `‚ùå Opponent held a card ‚Äî ${oppTeamName} gets the set!`;
  } else if (wrong > 0) {
    winner = null;
    reason = `‚ùå Wrong call (${wrong} error${wrong>1?'s':''}) ‚Äî set voided!
${errors.join(', ')}`;
  } else {
    winner = callingTeam;
    reason = `‚úÖ Perfect call ‚Äî ${callingTeamName} gets the set!`;
  }

  // Remove all cards from all hands
  allCards.forEach(card => {
    const key = ck(card);
    Object.keys(hands).forEach(pid => { hands[pid] = norm(hands[pid]).filter(c => ck(c) !== key); });
  });

  const newClaimed = [...(room.claimed||[])];
  if (winner !== null) {
    newClaimed.push({halfSuitId:hs.id, team:winner});
    if (winner===0) room.greenScore=(room.greenScore||0)+1;
    else            room.blueScore =(room.blueScore||0)+1;
  }
  room.claimed    = newClaimed;
  room.hands      = hands;
  room.lastAction = reason.split('\n')[0];
  room.logs       = room.logs||[];
  room.logs.unshift(`üì£ ${callingTeamName} called ${hs.name}: ${winner===callingTeam?'‚úÖ':'‚ùå'}`);
  room.logs       = room.logs.slice(0,20);

  const total = Object.values(hands).reduce((s,h) => s+norm(h).length, 0);
  if (newClaimed.length >= HALFSUITS.length || total === 0) room.phase = 'over';

  announce(reason.split('\n')[0]);
  showModal('üì£ Call Result', reason.replace(/\n/g,'<br>'));

  if (isDemo) {
    demoRoom = room;
    renderGame(room);
    if (room.phase === 'over') clearInterval(demoInterval);
  } else {
    const updates = {
      claimed:room.claimed, greenScore:room.greenScore, blueScore:room.blueScore,
      lastAction:room.lastAction, logs:room.logs, phase:room.phase
    };
    allCards.forEach((_, i) => {}); // cards already removed above
    Object.keys(hands).forEach(pid => { updates[`hands/${pid}`] = hands[pid]; });
    await dbUpdate(gameCode, updates);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIREBASE LISTENER ‚Äî handle announcements
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const _origEnter = enterGame;
function enterGame(init) {
  showScreen('screen-game');
  document.getElementById('btn-share').style.display=isDemo?'none':'block';
  showChatBtn(true);
  if (!isDemo) { listenChat(); startKeepAlive(); saveSession(); }
  else { addSystemMsg('üí¨ Chat disabled in demo mode'); }
  renderGame(init);
  if(!isDemo) {
    dbListen(gameCode, room=>{
      if(!room) return;
      // Show announcement to ALL players when it changes
      if(room.announcement) announce(room.announcement);
      renderGame(room);
      if(room.phase==='over') {
        dbUnlisten();
        const w=room.greenScore>room.blueScore?'üü¢ Green':room.blueScore>room.greenScore?'üîµ Blue':null;
        setTimeout(()=>showModal('üêü Game Over!',
          w?`${w} team wins ${room.greenScore}‚Äì${room.blueScore}!`:`Tie! ${room.greenScore}‚Äì${room.blueScore}`),600);
      }
    });
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEMO MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startDemo() {
  isDemo=true; gameCode='DEMO'; myId=0; myTeam=0; myName='You';
  const names=['You','Sarah','Brian','Steve','Mia','Zara'];
  const teams=[0,1,0,1,0,1];
  const emojis=['üòé','üê±','ü¶ä','üê∏','üå∏','‚ö°'];
  const deck=shuffle(buildDeck()); const pp=Math.floor(deck.length/6);
  const hands={}; for(let i=0;i<6;i++) hands[i]=deck.splice(0,pp).sort(csort);
  const players={}; for(let i=0;i<6;i++) players[i]={id:i,name:names[i],team:teams[i],emoji:emojis[i],ready:true};
  demoRoom={code:'DEMO',phase:'game',players,hands,currentPlayer:0,claimed:[],
    lastAction:'üéÆ Demo! Tap a card then ask an opponent.',
    greenScore:0,blueScore:0,logs:['Demo started!'],creator:0};
  showScreen('screen-game');
  document.getElementById('btn-share').style.display='none';
  renderGame(demoRoom);
  if(demoInterval) clearInterval(demoInterval);
  demoInterval=setInterval(demoTick,2000);
}

function demoTick() {
  if(!demoRoom||demoRoom.phase!=='game'||demoRoom.currentPlayer===myId) return;
  demoAIMove();
}

function demoAIMove() {
  const r=demoRoom; const pid=r.currentPlayer; const player=r.players[pid];
  if(!player) return;
  const hand=norm(r.hands[pid]);
  if(!hand.length){let n=(pid+1)%6;for(let i=0;i<6;i++){if(norm(r.hands[n]).length>0)break;n=(n+1)%6;}r.currentPlayer=n;renderGame(r);return;}
  const teamIds=Object.values(r.players).filter(p=>p.team===player.team).map(p=>p.id);
  for(const hs of HALFSUITS){
    if((r.claimed||[]).some(c=>c.halfSuitId===hs.id)) continue;
    const tc=[]; teamIds.forEach(tid=>norm(r.hands[tid]).filter(c=>c.hs===hs.id).forEach(c=>tc.push({card:c,pid:tid})));
    if(tc.length===6){
      r.claimed=[...(r.claimed||[]),{halfSuitId:hs.id,team:player.team}];
      if(player.team===0)r.greenScore=(r.greenScore||0)+1; else r.blueScore=(r.blueScore||0)+1;
      tc.forEach(({card,pid:p2})=>{r.hands[p2]=norm(r.hands[p2]).filter(c=>ck(c)!==ck(card));});
      r.lastAction=`üèÜ ${player.name} claimed ${hs.name}!`;
      r.logs=r.logs||[]; r.logs.unshift(`üèÜ ${player.name} claimed ${hs.name}!`);
      announce(`<span class="ann-trophy">üèÜ ${player.name}</span> claimed <b>${hs.name}</b>!`);
      const total=Object.values(r.hands).reduce((s,h)=>s+norm(h).length,0);
      if(r.claimed.length>=9||total===0){r.phase='over';clearInterval(demoInterval);}
      renderGame(r); return;
    }
  }
  const hsInHand=[...new Set(hand.map(c=>c.hs))];
  const chosenHs=hsInHand[Math.floor(Math.random()*hsInHand.length)];
  const hs=HALFSUITS.find(h=>h.id===chosenHs);
  const ownKeys=new Set(hand.filter(c=>c.hs===chosenHs).map(c=>ck(c)));
  const missing=hs.ranks.map(r2=>r2+hs.suit).filter(k=>!ownKeys.has(k));
  if(!missing.length){r.currentPlayer=(pid+1)%6;renderGame(r);return;}
  const tk=missing[Math.floor(Math.random()*missing.length)];
  const sc=tk.slice(-1); const rk=tk.slice(0,-1);
  const opps=Object.values(r.players).filter(p=>p.team!==player.team&&norm(r.hands[p.id]).length>0);
  if(!opps.length){r.currentPlayer=(pid+1)%6;renderGame(r);return;}
  const opp=opps[Math.floor(Math.random()*opps.length)];
  const oh=norm(r.hands[opp.id]);
  const hasIt=oh.some(c=>ck(c)===tk);
  r.logs=r.logs||[];
  if(hasIt){
    r.hands[opp.id]=oh.filter(c=>ck(c)!==tk);
    r.hands[pid]=[...hand,{rank:rk,suit:sc,hs:chosenHs}].sort(csort);
    r.lastAction=`<span class="yes">‚úÖ ${player.name} got ${rk}${sc}!</span>`;
    r.logs.unshift(`${player.name} took ${rk}${sc} from ${opp.name}`);
    announce(`<span class="ann-yes">‚úÖ ${player.name}</span> took <b>${rk}${sc}</b> from <b>${opp.name}</b>!`);
  } else {
    r.lastAction=`<span class="no">‚ùå ${opp.name} didn't have it</span>`;
    r.logs.unshift(`${player.name} asked ${opp.name} ‚Äî nope`);
    announce(`<span class="ann-no">‚ùå ${opp.name}</span> didn't have <b>${rk}${sc}</b>`);
    let next=opp.id; for(let i=0;i<6;i++){if(norm(r.hands[next]).length>0)break;next=(next+1)%6;}
    r.currentPlayer=next;
  }
  r.logs=r.logs.slice(0,20); renderGame(r);
}

function demoAskCard(card,targetId) {
  const r=demoRoom;
  if(r.currentPlayer!==myId){toast("Not your turn!");return;}
  const mh=norm(r.hands[myId]);
  if(!mh.some(c=>c.hs===card.hs)){toast('Need a card in that half-suit!');return;}
  if(mh.some(c=>ck(c)===ck(card))){toast('Already have that!');return;}
  const th=norm(r.hands[targetId]); const tp=r.players[targetId];
  const hasIt=th.some(c=>ck(c)===ck(card)); r.logs=r.logs||[];
  if(hasIt){
    r.hands[targetId]=th.filter(c=>ck(c)!==ck(card));
    r.hands[myId]=[...mh,card].sort(csort);
    r.lastAction=`<span class="yes">‚úÖ Got it!</span><br>${tp.name} had ${card.rank}${card.suit}`;
    r.logs.unshift(`You took ${card.rank}${card.suit} from ${tp.name}!`);
    announce(`<span class="ann-yes">‚úÖ You</span> took <b>${card.rank}${card.suit}</b> from <b>${tp.name}</b>!`);
  } else {
    r.lastAction=`<span class="no">‚ùå Go Fish!</span><br>${tp.name} doesn't have it`;
    r.logs.unshift(`${tp.name} didn't have ${card.rank}${card.suit}`);
    announce(`<span class="ann-no">‚ùå ${tp.name}</span> didn't have <b>${card.rank}${card.suit}</b>`);
    let next=targetId; for(let i=0;i<6;i++){if(norm(r.hands[next]).length>0)break;next=(next+1)%6;}
    r.currentPlayer=next;
  }
  r.logs=r.logs.slice(0,20); selectedCard=null; selectedAskCard=null; renderGame(r);
}

// demoStartClaim removed ‚Äî openCallModal handles demo too

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderSlots(container,players) {
  container.innerHTML='';
  // Show all 6 slots always
  for(let i=0;i<6;i++){
    const p=players[i]||null;
    const slot=document.createElement('div');
    if(p){
      const teamColor=p.team===0?'#2ecc71':'#3498db';
      slot.className=`slot f${p.team}`;
      slot.innerHTML=`
        <span class="sdot t${p.team}"></span>
        <span class="sname">${p.emoji} ${p.name}</span>
        ${p.id===myId?'<span class="syou">YOU</span>':''}
        <span style="margin-left:auto;font-size:9px;font-weight:900;color:${p.team===0?'#2ecc71':'#3498db'}">${p.team===0?'GREEN':'BLUE'}</span>`;
    } else {
      slot.className='slot';
      slot.innerHTML=`<span style="font-size:13px;opacity:.4">‚¨ú</span><span class="sempty">Slot ${i+1} open</span>`;
    }
    container.appendChild(slot);
  }
}

function updateUrlCode(code) {
  try {
    const clean=code.replace(/[^A-Z0-9]/gi,'').toUpperCase();
    const url=new URL(window.location.href);
    url.searchParams.set('code',clean);
    window.history.replaceState({},'',url.toString());
  } catch(e){}
}

function copyCode() { navigator.clipboard.writeText(gameCode||'').then(()=>toast('Code copied! üìã')); }
function shareLink() {
  const clean=(gameCode||'').replace(/[^A-Z0-9]/gi,'').toUpperCase();
  const link=`${window.location.origin}${window.location.pathname}?code=${clean}`;
  if(navigator.share) navigator.share({title:'üêü Join my Fish game!',text:`Code: ${clean}`,url:link}).catch(()=>{});
  else navigator.clipboard.writeText(link).then(()=>toast('Link copied! üîó'));
}

function toast(msg) {
  const el=document.getElementById('toast');
  el.textContent=msg; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),2800);
}
function showModal(title,body) {
  document.getElementById('modal-title').textContent=title;
  document.getElementById('modal-body').innerHTML=body;
  document.getElementById('modal').classList.remove('hidden');
}
function closeModal() { document.getElementById('modal').classList.add('hidden'); }

function showRules() {
  showModal('üìñ Fish Rules',
    `<b>Half-suits:</b> Low (2‚Äì7) or High (9‚ÄìA) of one suit = 6 cards.<br><br>
    <b>Your turn:</b> Tap a card you have, then ask an opponent for a card you DON'T have from the same half-suit.<br><br>
    <b>Got it?</b> You keep asking! <b>Nope?</b> Turn passes to them.<br><br>
    <b>Claim:</b> When your team holds all 6 of a half-suit, tap üèÜ Claim.<br><br>
    <b>Win:</b> Most half-suits claimed wins. 8 total!`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let chatOpen = false;
let chatUnreadCount = 0;
let lastChatKey = null;

function toggleChat() {
  chatOpen = !chatOpen;
  document.getElementById('chat-panel').classList.toggle('open', chatOpen);
  if (chatOpen) {
    chatUnreadCount = 0;
    ['chat-unread','chat-unread2'].forEach(id => {
      const b = document.getElementById(id);
      if (b) { b.style.display = 'none'; b.textContent = ''; }
    });
    if (!isDemo) setTimeout(() => document.getElementById('chat-input').focus(), 300);
    scrollChatToBottom();
  }
}

function scrollChatToBottom() {
  const el = document.getElementById('chat-messages');
  el.scrollTop = el.scrollHeight;
}

function showChatBtn(show) {
  document.getElementById('chat-btn').style.display = show ? 'flex' : 'none';
}

async function sendChat() {
  const input = document.getElementById('chat-input');
  const text = input.value.trim();
  if (!text) return;
  if (isDemo) { 
    appendChatMsg({name: myName||'You', team: myTeam, text, ts: Date.now(), id: myId}, true);
    input.value = '';
    scrollChatToBottom();
    return;
  }
  if (!gameCode) return;
  input.value = '';
  const msg = {
    name: myName,
    team: myTeam,
    text,
    ts: Date.now(),
    id: myId,
  };
  const key = Date.now() + '_' + Math.random().toString(36).slice(2,6);
  await db.ref(`fish/${gameCode}/chat/${key}`).set(msg);
}

function listenChat() {
  if (!gameCode || isDemo) return;
  const chatRef = db.ref(`fish/${gameCode}/chat`);
  chatRef.limitToLast(100).on('child_added', snap => {
    const msg = snap.val();
    if (!msg) return;
    // Skip messages we've seen before (from initial load)
    if (lastChatKey === null) { lastChatKey = snap.key; }
    appendChatMsg(msg, Number(msg.id) === Number(myId));
    if (!chatOpen && Number(msg.id) !== Number(myId)) {
      chatUnreadCount++;
      ['chat-unread','chat-unread2'].forEach(id => {
        const b = document.getElementById(id);
        if (b) { b.textContent = chatUnreadCount; b.style.display = 'flex'; }
      });
    }
    scrollChatToBottom();
  });
}

function appendChatMsg(msg, isMine) {
  const container = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'cmsg ' + (isMine ? 'mine' : 'theirs t' + msg.team);
  const time = new Date(msg.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  const teamDot = msg.team===0 ? 'üü¢' : 'üîµ';
  const nameHtml = !isMine ? '<div class="cmsg-name">' + teamDot + ' ' + escHtml(msg.name) + '</div>' : '';
  const bubbleHtml = '<div class="cmsg-bubble">' + escHtml(msg.text) + '</div>';
  const timeHtml = '<div class="cmsg-time">' + time + '</div>';
  div.innerHTML = nameHtml + bubbleHtml + timeHtml;
  container.appendChild(div);
}

function addSystemMsg(text) {
  const container = document.getElementById('chat-messages');
  const div = document.createElement('div');
  div.className = 'csystem';
  div.textContent = text;
  container.appendChild(div);
  scrollChatToBottom();
}

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SESSION PERSISTENCE ‚Äî survive page reloads & AFK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function saveSession() {
  if (isDemo || !gameCode) return;
  sessionStorage.setItem('fish_session', JSON.stringify({
    gameCode, myId, myTeam, myName, ts: Date.now()
  }));
}

function clearSession() {
  sessionStorage.removeItem('fish_session');
}

function loadSession() {
  try {
    const s = sessionStorage.getItem('fish_session');
    if (!s) return null;
    const d = JSON.parse(s);
    // Expire after 4 hours
    if (Date.now() - d.ts > 4 * 60 * 60 * 1000) { clearSession(); return null; }
    return d;
  } catch(e) { return null; }
}

async function tryReconnect(session) {
  // Restore local state
  gameCode = session.gameCode;
  myId     = session.myId;
  myTeam   = session.myTeam;
  myName   = session.myName;
  isDemo   = false;

  const room = await dbGet(gameCode);
  if (!room) {
    clearSession();
    toast('Your game room has expired.');
    return false;
  }

  // Make sure our player record still exists (write it back if missing)
  const players = room.players || {};
  if (!players[myId]) {
    // Re-insert ourselves silently
    await rref(gameCode).child('players').child(String(myId)).set({
      id: myId, name: myName, team: myTeam,
      emoji: (players[myId]||{}).emoji || randEmoji(), ready: true
    });
  }

  updateUrlCode(gameCode);
  saveSession(); // refresh timestamp

  if (room.phase === 'lobby') {
    showWaiting();
  } else {
    // Game in progress ‚Äî jump back in
    const me = room.players && room.players[myId];
    if (me) { myTeam = me.team; myName = me.name; }
    enterGame(room);
  }
  return true;
}

// Keep Firebase connection alive ‚Äî ping every 30s so the connection
// doesn't time out on mobile when the screen locks
let _keepAliveInterval = null;
function startKeepAlive() {
  if (_keepAliveInterval) return;
  _keepAliveInterval = setInterval(() => {
    if (!gameCode || isDemo) return;
    // Write a harmless timestamp to our own player record
    try {
      rref(gameCode).child('players').child(String(myId)).child('ping')
        .set(Date.now());
    } catch(e) {}
  }, 30000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STARTUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function init() {
  initFB();
  const params=new URLSearchParams(window.location.search);
  // Auto-launch demo if ?demo=1
  if(params.get('demo')==='1') { startDemo(); return; }

  // Try reconnecting from session storage (handles page refresh & AFK return)
  const session = loadSession();
  if (session) {
    tryReconnect(session).then(ok => {
      if (!ok) showScreen('screen-lobby');
    });
    return;
  }

  const urlCode=params.get('code');
  if(urlCode) {
    const clean=urlCode.replace(/[^A-Z0-9]/gi,'').toUpperCase().slice(0,6);
    if(clean.length>=4){
      joinCodeVal=clean;
      document.getElementById('join-code-input').value=clean;
      document.getElementById('join-code-display').textContent=clean;
      pickJoinTeam(0);
      showScreen('screen-join');
      setTimeout(refreshJoinRoom,800);
      return;
    }
  }
  showScreen('screen-lobby');
})();
</script>
</body>
</html>
